stages:
  - test
  - scan
  - report

variables:
  NODE_VERSION: '20'
  GUARDIAN_URL: '${CI_ENVIRONMENT_URL}'
  ARTIFACTS_DIR: 'artifacts/guardian'
  NPM_CACHE_DIR: '${CI_PROJECT_DIR}/.npm'
  PLAYWRIGHT_CACHE_DIR: '${CI_PROJECT_DIR}/.playwright'
  GUARDIAN_FAIL_ON: 'any'

cache:
  paths:
    - ${NPM_CACHE_DIR}
    - ${PLAYWRIGHT_CACHE_DIR}

guardian:scan:
  stage: scan
  image: node:${NODE_VERSION}
  timeout: 15 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - script_failure
  before_script:
    - npm config set cache ${NPM_CACHE_DIR}
    - npm ci
    - export PLAYWRIGHT_BROWSERS_PATH=${PLAYWRIGHT_CACHE_DIR}/ms-playwright
    - npx playwright install --with-deps chromium
  script:
    - mkdir -p ${ARTIFACTS_DIR}
    - >
      if [ -z "$GUARDIAN_URL" ]; then
        echo "‚ùå GUARDIAN_URL not set. Set CI/CD variable GUARDIAN_URL (or CI_ENVIRONMENT_URL)." >&2;
        exit 1;
      fi;
      if ! echo "$GUARDIAN_URL" | grep -qE '^https?://'; then
        echo "‚ùå GUARDIAN_URL must be a valid http/https URL." >&2;
        exit 1;
      fi;
      echo "üõ°Ô∏è  Guardian reality check: $GUARDIAN_URL";
      MAX_ATTEMPTS=3
      ATTEMPT=1
      EXIT_CODE=0
      TIMEOUT_SECONDS=600
      RETRY_DELAYS="3 8"
      
      while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
        echo "Guardian attempt $ATTEMPT of $MAX_ATTEMPTS"
        EXIT_CODE=0
        timeout $TIMEOUT_SECONDS npx -y @odavl/guardian reality \
          --url "$GUARDIAN_URL" \
          --artifacts "${ARTIFACTS_DIR}" \
          --preset startup \
          --no-trace \
          --no-screenshots \
          --fast || EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 1 ] || [ $EXIT_CODE -eq 2 ]; then
          echo "‚úì Guardian completed with exit code: $EXIT_CODE"
          break
        elif [ $EXIT_CODE -eq 124 ]; then
          echo "‚ö†Ô∏è  Guardian timed out (exit 124) on attempt $ATTEMPT"
          if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            DELAY=$(echo $RETRY_DELAYS | awk -v a=$ATTEMPT '{print $a}')
            [ -z "$DELAY" ] && DELAY=8
            echo "Waiting ${DELAY}s before retry..."
            sleep $DELAY
          fi
        else
          echo "‚ö†Ô∏è  Guardian failed with exit code $EXIT_CODE on attempt $ATTEMPT"
          if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            DELAY=$(echo $RETRY_DELAYS | awk -v a=$ATTEMPT '{print $a}')
            [ -z "$DELAY" ] && DELAY=8
            echo "Waiting ${DELAY}s before retry..."
            sleep $DELAY
          fi
        fi
        ATTEMPT=$((ATTEMPT+1))
      done
      
      if [ $EXIT_CODE -eq 124 ]; then
        echo "‚ùå Guardian timed out after $MAX_ATTEMPTS attempts"
        exit 124
      fi
      echo "GUARDIAN_EXIT_CODE=$EXIT_CODE" >> build.env
  artifacts:
    name: guardian-report-$CI_COMMIT_SHORT_SHA
    paths:
      - ${ARTIFACTS_DIR}/**
    reports:
      junit: ${ARTIFACTS_DIR}/**/junit.xml
    expire_in: 30 days
    when: always
  after_script:
    - |
      DECISION_FILE=$(find ${ARTIFACTS_DIR} -name "decision.json" -type f | head -n 1)
      if [ -f "$DECISION_FILE" ]; then
        VERDICT=$(node -e "const fs = require('fs'); const d = JSON.parse(fs.readFileSync('$DECISION_FILE', 'utf8')); console.log(d.finalVerdict || 'UNKNOWN');")
        echo "üìä Guardian Verdict: $VERDICT"
        echo "Policy: FAIL_ON=$GUARDIAN_FAIL_ON"
        
        case "$GUARDIAN_FAIL_ON" in
          none)
            echo "‚úì No failure policy; job may pass"
            ;;
          friction)
            if [ "$VERDICT" = "FRICTION" ]; then
              echo "‚ùå FRICTION blocks job (fail-on=friction)"
              exit 1
            else
              echo "‚úì No friction; job passes"
            fi
            ;;
          risk)
            if [ "$VERDICT" = "DO_NOT_LAUNCH" ]; then
              echo "‚ùå DO_NOT_LAUNCH blocks job (fail-on=risk)"
              exit 1
            else
              echo "‚úì No critical risk; job passes"
            fi
            ;;
          any)
            if [ "$VERDICT" = "FRICTION" ] || [ "$VERDICT" = "DO_NOT_LAUNCH" ]; then
              echo "‚ùå $VERDICT blocks job (fail-on=any)"
              exit 1
            else
              echo "‚úì READY; job passes"
            fi
            ;;
        esac
      fi
  allow_failure: false

guardian:validate:
  stage: scan
  image: node:${NODE_VERSION}
  dependencies:
    - guardian:scan
  script:
    - |
      DECISION_FILE=$(find ${ARTIFACTS_DIR} -name "decision.json" -type f | head -n 1)
      if [ -z "$DECISION_FILE" ]; then
        echo "‚ùå No decision.json found"
        exit 1
      fi
      
      VERDICT=$(node -e "
        const fs = require('fs');
        const d = JSON.parse(fs.readFileSync('$DECISION_FILE', 'utf8'));
        console.log(d.finalVerdict || 'UNKNOWN');
      ")
      
      if ! echo "$VERDICT" | grep -qE '^(READY|FRICTION|DO_NOT_LAUNCH)$'; then
        echo "‚ùå Invalid verdict: $VERDICT"
        exit 1
      fi
      
      echo "‚úì Verdict validated: $VERDICT"
      echo "GUARDIAN_VERDICT=$VERDICT" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  allow_failure: false
  only:
    - main
    - merge_requests

guardian:report:
  stage: report
  image: alpine:latest
  dependencies:
    - guardian:scan
    - guardian:validate
  script:
    - |
      DECISION_FILE=$(find ${ARTIFACTS_DIR} -name "decision.json" -type f | head -n 1)
      if [ -f "$DECISION_FILE" ]; then
        echo "üìä Guardian Decision Summary:"
        cat "$DECISION_FILE" | grep -o '"finalVerdict":"[^"]*"' || echo "Cannot parse verdict"
      else
        echo "‚ÑπÔ∏è  No decision.json found"
      fi
  when: always
  allow_failure: true
  only:
    - main
    - merge_requests

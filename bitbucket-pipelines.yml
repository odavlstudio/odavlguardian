image: node:20

definitions:
  variables:
    GUARDIAN_FAIL_ON: 'any'
  caches:
    npm: ~/.npm
    playwright: ~/.cache/ms-playwright

  steps:
    - step: &guardian-scan
        name: Guardian Reality Check
        max-time: 15
        script:
          - npm config set cache ~/.npm
          - npm ci
          - export PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright
          - npx playwright install --with-deps chromium
          - mkdir -p artifacts/guardian
          - |
            GUARDIAN_URL="${GUARDIAN_URL}"
            if [ -z "$GUARDIAN_URL" ]; then
              echo "‚ùå GUARDIAN_URL not set. Configure Repository variables -> GUARDIAN_URL." >&2
              exit 1
            fi
            if ! echo "$GUARDIAN_URL" | grep -qE '^https?://'; then
              echo "‚ùå GUARDIAN_URL must be a valid http/https URL." >&2
              exit 1
            fi
          - echo "üõ°Ô∏è  Guardian reality check: $GUARDIAN_URL"
          - |
            MAX_ATTEMPTS=3
            ATTEMPT=1
            EXIT_CODE=0
            TIMEOUT_SECONDS=600
            RETRY_DELAYS="3 8"
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "Guardian attempt $ATTEMPT of $MAX_ATTEMPTS"
              EXIT_CODE=0
              timeout $TIMEOUT_SECONDS npx -y @odavl/guardian reality \
                --url "$GUARDIAN_URL" \
                --artifacts "artifacts/guardian" \
                --preset startup \
                --no-trace \
                --no-screenshots \
                --fast || EXIT_CODE=$?
              
              if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 1 ] || [ $EXIT_CODE -eq 2 ]; then
                echo "‚úì Guardian completed with exit code: $EXIT_CODE"
                break
              elif [ $EXIT_CODE -eq 124 ]; then
                echo "‚ö†Ô∏è  Guardian timed out (exit 124) on attempt $ATTEMPT"
                if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                  DELAY=$(echo $RETRY_DELAYS | awk -v a=$ATTEMPT '{print $a}')
                  [ -z "$DELAY" ] && DELAY=8
                  echo "Waiting ${DELAY}s before retry..."
                  sleep $DELAY
                fi
              else
                echo "‚ö†Ô∏è  Guardian failed with exit code $EXIT_CODE on attempt $ATTEMPT"
                if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                  DELAY=$(echo $RETRY_DELAYS | awk -v a=$ATTEMPT '{print $a}')
                  [ -z "$DELAY" ] && DELAY=8
                  echo "Waiting ${DELAY}s before retry..."
                  sleep $DELAY
                fi
              fi
              ATTEMPT=$((ATTEMPT+1))
            done
            
            if [ $EXIT_CODE -eq 124 ]; then
              echo "‚ùå Guardian timed out after $MAX_ATTEMPTS attempts"
              exit 124
            fi
            
            echo "Guardian exit code: $EXIT_CODE"
        artifacts:
          - artifacts/guardian/**
        after-script:
          - |
            DECISION_FILE=$(find artifacts/guardian -name "decision.json" -type f | head -n 1)
            if [ -f "$DECISION_FILE" ]; then
              echo "üìä Guardian Decision Summary:"
              VERDICT=$(node -e "const fs = require('fs'); const d = JSON.parse(fs.readFileSync('$DECISION_FILE', 'utf8')); console.log(d.finalVerdict || 'UNKNOWN');")
              echo "Verdict: $VERDICT"
              echo "Policy: FAIL_ON=$GUARDIAN_FAIL_ON"
              
              if ! echo "$VERDICT" | grep -qE '^(READY|FRICTION|DO_NOT_LAUNCH)$'; then
                echo "‚ùå Invalid verdict: $VERDICT"
                exit 1
              fi
              
              case "$GUARDIAN_FAIL_ON" in
                none)
                  echo "‚úì No failure policy; step may pass"
                  ;;
                friction)
                  if [ "$VERDICT" = "FRICTION" ]; then
                    echo "‚ùå FRICTION blocks step (fail-on=friction)"
                    exit 1
                  else
                    echo "‚úì No friction; step passes"
                  fi
                  ;;
                risk)
                  if [ "$VERDICT" = "DO_NOT_LAUNCH" ]; then
                    echo "‚ùå DO_NOT_LAUNCH blocks step (fail-on=risk)"
                    exit 1
                  else
                    echo "‚úì No critical risk; step passes"
                  fi
                  ;;
                any)
                  if [ "$VERDICT" = "FRICTION" ] || [ "$VERDICT" = "DO_NOT_LAUNCH" ]; then
                    echo "‚ùå $VERDICT blocks step (fail-on=any)"
                    exit 1
                  else
                    echo "‚úì READY; step passes"
                  fi
                  ;;
              esac
            else
              echo "‚ö†Ô∏è  No decision.json found"
            fi
        caches:
          - npm
          - playwright

pipelines:
  default:
    - step: *guardian-scan
  branches:
    main:
      - step: *guardian-scan
    develop:
      - step: *guardian-scan
    feature/*:
      - step: *guardian-scan

options:
  max-time: 30

name: Action Self-Test

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  local-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run action from repo (local)
        id: local
        uses: ./
        with:
          url: https://example.com
          preset: startup
          fail-on: none
          artifacts: .odavlguardian-selftest/local

      - name: Validate local action outputs
        run: |
          set -euo pipefail
          echo "Validating local action outputs..."
          test -d .odavlguardian-selftest/local || { echo "::error::Artifacts directory missing" >&2; exit 1; }
          test -f .odavlguardian-selftest/local/decision.json || { echo "::error::decision.json not found in artifacts" >&2; exit 1; }
          test -n "${{ steps.local.outputs.verdict }}" || { echo "::error::Missing verdict output" >&2; exit 1; }
          test -n "${{ steps.local.outputs.run-id }}" || { echo "::error::Missing run-id output" >&2; exit 1; }
          echo "verdict=${{ steps.local.outputs.verdict }}"
          echo "exit-code=${{ steps.local.outputs.exit-code }}"
          echo "run-id=${{ steps.local.outputs.run-id }}"
          case "${{ steps.local.outputs.verdict }}" in
            READY|FRICTION|DO_NOT_LAUNCH)
              echo "✓ Local action verdict is valid"
              ;;
            *)
              echo "::error::Invalid verdict: ${{ steps.local.outputs.verdict }}" >&2
              exit 1
              ;;
          esac

  tag-drift-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce v1 tag freshness for action changes
        run: |
          set -euo pipefail
          git fetch --tags --force
          if ! git rev-parse --verify refs/tags/v1 >/dev/null 2>&1; then
            echo "::error::Published action tag 'v1' is missing. Run the Action Release Tag workflow to publish it before merging." >&2
            exit 1
          fi
          if git diff --quiet refs/tags/v1...HEAD -- action.yml; then
            echo "action.yml matches published v1" && exit 0
          fi
          echo "::error::action.yml differs from published v1. Run the Action Release Tag workflow to update v1 before merging." >&2
          git diff --stat refs/tags/v1...HEAD -- action.yml || true
          exit 1

  remote-action:
    runs-on: ubuntu-latest
    needs: tag-drift-guard
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run published action
        id: remote
        uses: odavlstudio/odavlguardian@v1
        with:
          url: https://example.com
          preset: startup
          fail-on: none
          artifacts: .odavlguardian-selftest/remote

      - name: Validate published action outputs
        run: |
          set -euo pipefail
          echo "Validating published action outputs..."
          test -d .odavlguardian-selftest/remote || { echo "::error::Published action artifacts missing" >&2; exit 1; }
          test -f .odavlguardian-selftest/remote/decision.json || { echo "::error::decision.json not found in published artifacts" >&2; exit 1; }
          test -n "${{ steps.remote.outputs.verdict }}" || { echo "::error::Missing verdict output" >&2; exit 1; }
          test -n "${{ steps.remote.outputs.run-id }}" || { echo "::error::Missing run-id output" >&2; exit 1; }
          echo "verdict=${{ steps.remote.outputs.verdict }}"
          echo "exit-code=${{ steps.remote.outputs.exit-code }}"
          echo "run-id=${{ steps.remote.outputs.run-id }}"
          case "${{ steps.remote.outputs.verdict }}" in
            READY|FRICTION|DO_NOT_LAUNCH)
              echo "✓ Published action verdict is valid"
              ;;
            *)
              echo "::error::Invalid verdict: ${{ steps.remote.outputs.verdict }}" >&2
              exit 1
              ;;
          esac
          echo "Remote action succeeded with verdict: ${{ steps.remote.outputs.verdict }}"

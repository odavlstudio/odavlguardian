name: Template Verification

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Lint templates
        run: npm run template:verify

      - name: Run Guardian example.com
        id: guardian
        run: |
          set +e
          mkdir -p artifacts/template-verification
          npx -y @odavl/guardian reality \
            --url https://example.com \
            --artifacts artifacts/template-verification \
            --no-trace \
            --no-screenshots \
            --fast
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Assert artifacts exist
        run: |
          RUN_DIR=$(ls -td artifacts/template-verification/* | head -n 1 || true)
          if [ -z "$RUN_DIR" ]; then
            echo "No Guardian artifacts produced" >&2
            exit 1
          fi
          test -f "$RUN_DIR/decision.json" || { echo "decision.json missing in $RUN_DIR" >&2; exit 1; }
          echo "Artifacts available at $RUN_DIR"

      - name: Upload sample artifacts
        uses: actions/upload-artifact@v4
        with:
          name: guardian-template-verification
          path: artifacts/template-verification

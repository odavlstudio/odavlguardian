name: Guardian PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  GUARDIAN_BASE_URL: ${{ secrets.GUARDIAN_PREVIEW_BASE_URL }}
  ARTIFACTS_DIR: artifacts/guardian/pr-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  guardian-pr:
    runs-on: ubuntu-latest
    if: ${{ secrets.GUARDIAN_PREVIEW_BASE_URL != '' }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # Skip hard failure when preview base URL is not configured (guarded at job level)

      - name: Run Guardian with retry (captures flakes)
        id: guardian-run
        continue-on-error: true
        run: |
          set -e
          mkdir -p "$ARTIFACTS_DIR"
          FLAKE_FILE="$ARTIFACTS_DIR/flake-info.txt"
          attempt=1
          exit_code=1
          flake_detected=false
          while [ $attempt -le 2 ]; do
            echo "Running Guardian attempt $attempt"
            npx -y @odavl/guardian reality \
              --url "$GUARDIAN_BASE_URL" \
              --artifacts "$ARTIFACTS_DIR" \
              --no-trace \
              --no-screenshots \
              --fast
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
              if [ $attempt -gt 1 ]; then
                flake_detected=true
                echo "Retry succeeded after transient failure" > "$FLAKE_FILE"
              fi
              break
            fi
            attempt=$((attempt+1))
          done
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          echo "flake_detected=$flake_detected" >> "$GITHUB_OUTPUT"

      - name: Summarize Guardian result
        id: summarize
        run: |
          set -euo pipefail
          if [ ! -d "$ARTIFACTS_DIR" ]; then
            echo "ARTIFACTS_DIR not found" >&2
            exit 1
          fi
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const artifactsDir = process.env.ARTIFACTS_DIR;
          const outputPath = process.env.GITHUB_OUTPUT;
          const runs = fs.readdirSync(artifactsDir).filter((n) => n.startsWith('run-')).sort();
          if (!runs.length) {
            console.error('No run directories found');
            process.exit(1);
          }
          const reportPath = path.join(artifactsDir, runs[runs.length - 1], 'report.json');
          if (!fs.existsSync(reportPath)) {
            console.error(`report.json missing at ${reportPath}`);
            process.exit(1);
          }
          const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
          const decision = report.finalJudgment?.decision || 'UNKNOWN';
          const confidence = report.confidence?.level || 'UNKNOWN';
          const coverage = report.coverage?.coveragePercent ?? 'n/a';
          const regressionStatus = report.regression?.status || 'none';
          const regressionReasons = (report.regression?.reasons || []).join(' | ') || 'none';
          const regressions = regressionStatus === 'regressed' ? 1 : 0;
          const summary = `Decision=${decision}; Confidence=${confidence}; Coverage=${coverage}; Regression=${regressionStatus}`;
          console.log(summary);
          fs.appendFileSync(outputPath, `decision=${decision}\n`);
          fs.appendFileSync(outputPath, `confidence=${confidence}\n`);
          fs.appendFileSync(outputPath, `coverage=${coverage}\n`);
          fs.appendFileSync(outputPath, `regression_status=${regressionStatus}\n`);
          fs.appendFileSync(outputPath, `regression_reasons=${regressionReasons}\n`);
          fs.appendFileSync(outputPath, `regressions=${regressions}\n`);
          fs.appendFileSync(outputPath, `report_path=${reportPath}\n`);
          NODE

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: guardian-pr-${{ github.run_number }}-${{ github.run_attempt }}
          path: ${{ env.ARTIFACTS_DIR }}

      - name: Comment on PR
        if: github.event.pull_request.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const decision = '${{ steps.summarize.outputs.decision }}';
            const confidence = '${{ steps.summarize.outputs.confidence }}';
            const coverage = '${{ steps.summarize.outputs.coverage }}';
            const regressionStatus = '${{ steps.summarize.outputs.regression_status }}';
            const regressionReasons = '${{ steps.summarize.outputs.regression_reasons }}';
            const flake = '${{ steps.guardian-run.outputs.flake_detected }}' === 'true';
            const artifactName = `guardian-pr-${{ github.run_number }}-${{ github.run_attempt }}`;
            const body = [
              `**Guardian PR Gate**`,
              `- Decision: ${decision}`,
              `- Confidence: ${confidence}`,
              `- Coverage: ${coverage}%`,
              `- Regressions: ${regressionStatus}${regressionReasons ? ` â€” ${regressionReasons}` : ''}`,
              `- Flake resolved: ${flake ? 'yes' : 'no'}`,
              `- Artifacts: ${artifactName}`
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Enforce Guardian policy
        run: |
          if [ "${{ steps.guardian-run.outputs.exit_code }}" != "0" ]; then
            echo "Guardian CLI exited with code ${{ steps.guardian-run.outputs.exit_code }}" >&2
            exit 1
          fi
          if [ "${{ steps.summarize.outputs.decision }}" = "DO_NOT_LAUNCH" ]; then
            echo "Guardian decision is DO_NOT_LAUNCH; blocking PR" >&2
            exit 1
          fi
          echo "Guardian decision READY; PR may proceed."
